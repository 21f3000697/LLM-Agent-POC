<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>LLM Agent POC</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <style>
    #chat { max-height: 400px; overflow-y: auto; }
    pre { background: #eee; padding: 5px; }
  </style>
</head>
<body class="p-3">
  <h3>ðŸ”— LLM Agent POC</h3>

  <div class="mb-2">
    <select id="model" class="form-select w-auto">
      <option value="gpt-4o-mini">GPT-4o-mini</option>
      <option value="gpt-3.5-turbo">GPT-3.5-turbo</option>
    </select>
  </div>
  <div id="chat" class="border rounded p-2 mb-3"></div>
  <div class="input-group">
    <input id="userInput" class="form-control" placeholder="Say something..." />
    <button id="sendBtn" class="btn btn-primary">Send</button>
  </div>
  <div id="alerts"></div>

  <script>
    const chat = document.getElementById("chat");
    const userInput = document.getElementById("userInput");
    const sendBtn = document.getElementById("sendBtn");
    const alerts = document.getElementById("alerts");

    let messages = [];

    function addMessage(role, text) {
      const el = document.createElement("div");
      el.innerHTML = `<b>${role}:</b> ${text}`;
      chat.appendChild(el);
      chat.scrollTop = chat.scrollHeight;
    }

    function showError(err) {
      alerts.innerHTML = `<div class="alert alert-danger">${err}</div>`;
    }

    async function handleToolCall(tc) {
      try {
        let res = await fetch("/llm-api", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ tool_call: tc })
        });
        let data = await res.json();
        return { role: "tool", name: tc.name, content: data.result };
      } catch (e) {
        showError(`Tool error: ${e.message}`);
      }
    }

    async function loop(userMsg) {
      if (userMsg) {
        messages.push({ role: "user", content: userMsg });
        addMessage("User", userMsg);
      }
      try {
        let resp = await fetch("/llm-api", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            model: document.getElementById("model").value,
            messages,
            tools: [
              { name: "search", description: "Google search snippet" },
              { name: "aipipe", description: "AI Pipe API" },
              { name: "run_js", description: "Execute JS" }
            ]
          })
        });
        let data = await resp.json();

        if (data.output) {
          addMessage("Agent", data.output);
          messages.push({ role: "assistant", content: data.output });
        }

        if (data.tool_calls && data.tool_calls.length > 0) {
          for (const tc of data.tool_calls) {
            let result = await handleToolCall(tc);
            addMessage("Tool", `${tc.name} â†’ ${result.content}`);
            messages.push(result);
          }
          loop(""); // continue loop for tool chain
        }
      } catch (e) {
        showError(`Agent error: ${e.message}`);
      }
    }

    sendBtn.onclick = () => {
      let msg = userInput.value.trim();
      if (msg) {
        loop(msg);
        userInput.value = "";
      }
    };
  </script>
</body>
</html>
